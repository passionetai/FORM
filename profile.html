<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Profile - DfyFx Trader</title>
    <link rel="stylesheet" href="style.css"> <!-- Reusing the main stylesheet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="profile-body"> <!-- Optional class -->

    <div class="container profile-page">
        <header class="page-header">
            <h1>Your Profile</h1>
            <p>Manage your account and e-vouchers</p>
        </header>

        <!-- Main Profile Card -->
        <section class="profile-card">
            <div class="profile-banner"></div>
            <div class="profile-avatar">
                <span id="profile-avatar-initial">J</span> <!-- Placeholder Initial -->
                <img id="profile-avatar-img" src="" alt="User Avatar" style="display: none; width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
            </div>
            <h2 class="profile-name" id="profile-main-name">John Doe</h2>

            <div class="profile-details">
                <!-- Full Name -->
                <div class="detail-item">
                    <i class="fas fa-user detail-icon"></i>
                    <div class="detail-text">
                        <span class="detail-label">Full Name</span>
                        <span class="detail-value" id="profile-detail-name">John Doe</span>
                    </div>
                </div>
                <!-- Email -->
                <div class="detail-item">
                    <i class="fas fa-envelope detail-icon"></i>
                    <div class="detail-text">
                        <span class="detail-label">Email</span>
                        <span class="detail-value" id="profile-email-value">john@example.com</span>
                    </div>
                </div>
                <!-- E-Voucher Credits item removed -->
            </div>

            <div class="profile-actions">
                <!-- Edit Profile Button Removed -->
                <a href="#" id="sign-out-btn" class="action-button">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </a>
            </div>
        </section> <!-- End .profile-card -->

        <!-- Wallet Section -->
        <section class="wallet-section">
            <h2>My Wallet</h2>

            <!-- Balance Display -->
            <div class="wallet-balance">
                <span class="balance-label">Current Balance:</span>
                <span class="balance-amount" id="wallet-current-balance">$0.00</span> <!-- Placeholder -->
            </div>

            <!-- Fund Wallet -->
            <div class="fund-wallet">
                <h3>Add Funds</h3>
                <div class="funding-options">
                    <!-- E-Voucher Purchase -->
                    <div class="funding-option voucher-funding">
                        <h4>Purchase E-Voucher</h4>
                        <div class="form-group">
                             <label for="voucher-amount">Amount ($):</label>
                            <input type="number" id="voucher-amount" class="form-control" placeholder="e.g., 50" min="1">
                        </div>
                        <button id="open-voucher-modal-btn" class="btn btn-secondary">Fund with Voucher</button>
                        <!-- Removed redirection paragraph -->
                    </div>

                    <!-- Crypto Deposit -->
                    <div class="funding-option crypto-funding">
                        <h4>Deposit Crypto</h4>
                        <div class="form-group">
                            <label for="crypto-select">Select Coin:</label>
                            <select id="crypto-select" class="form-control">
                                <option value="btc">Bitcoin (BTC)</option>
                                <option value="eth">Ethereum (ETH)</option>
                                <option value="usdt">Tether (USDT)</option>
                                <!-- Add other supported cryptos -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="crypto-amount">Amount (Approx. USD):</label>
                            <input type="number" id="crypto-amount" class="form-control" placeholder="e.g., 100" min="1">
                            <button id="post-crypto-amount-btn" class="btn btn-secondary btn-small btn-outline" style="margin-top: 10px;">Post Amount</button> <!-- Added Post Amount button -->
                        </div>
                        <div class="crypto-deposit-details">
                            <p>Send <span id="selected-crypto-name">Bitcoin</span> to the address below:</p>
                            <div id="crypto-deposit-address" class="crypto-address-box">
                                <!-- Placeholder Address -->
                                bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh
                            </div>
                            <!-- QR Code Image Removed -->
                            <p class="crypto-warning">Ensure you send only <span id="selected-crypto-name-warn">Bitcoin</span> to this address. Sending other coins may result in loss of funds.</p>

                            <!-- Confirmation Section -->
                            <div class="form-group" style="margin-top: 20px; margin-bottom: 0;"> <!-- Added margin-top, removed default bottom margin -->
                                <label for="crypto-txid">Transaction ID (Required after posting amount):</label>
                                <input type="text" id="crypto-txid" class="form-control" placeholder="Enter Transaction ID / Hash" disabled>
                            </div>
                             <button id="confirm-crypto-sent-btn" class="btn btn-success" style="margin-top: 15px; width: 100%;" disabled>I Have Sent The Crypto</button> <!-- Added Confirmation button -->
                        </div>
                    </div>
                </div>

                <!-- Manual Payment Instructions -->
                <div class="manual-funding-info funding-option"> <!-- Reusing funding-option for similar styling -->
                    <h4>Manual Payment (WorldRemit / MTN MoMo)</h4>
                    <p>To fund your wallet using WorldRemit or MTN Mobile Money, please follow these steps:</p>
                    <ol>
                        <li>Send payment to [Your WorldRemit/MTN Details Here - e.g., Name, Number, Country].</li>
                        <li>Take a clear screenshot or note down the transaction reference number.</li>
                        <li>Email the proof of payment (screenshot/reference) along with your registered email address to: <a href="mailto:support@dfyfx.com">support@dfyfx.com</a>.</li>
                        <li>Your account will be credited manually by an admin upon verification (usually within 24 hours).</li>
                    </ol>
                    <p><strong>Note:</strong> Ensure all details are correct before sending payment.</p>
                </div>

            </div>

            <!-- Transaction History -->
            <div class="transaction-history">
                <h3>Transaction History</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-history-body">
                        <!-- Placeholder Transactions -->
                        <tr>
                            <td>2025-03-29</td>
                            <td>Deposit</td>
                            <td>E-Voucher Redeemed</td>
                            <td class="amount-positive">+$50.00</td>
                            <td class="status-completed">Completed</td>
                        </tr>
                        <tr>
                            <td>2025-03-28</td>
                            <td>Purchase</td>
                            <td>Signal Subscription (1 Month)</td>
                            <td class="amount-negative">-$25.00</td>
                            <td class="status-completed">Completed</td>
                        </tr>
                         <tr>
                            <td>2025-03-27</td>
                            <td>Deposit</td>
                            <td>Crypto Deposit (BTC)</td>
                            <td class="amount-positive">+$100.00</td>
                            <td class="status-pending">Pending (2/6 Conf)</td>
                        </tr>
                        <!-- More transactions loaded via JS -->
                    </tbody>
                </table>
            </div>
        </section> <!-- End .wallet-section -->

        <!-- CTA Card for Buying Vouchers -->
        <section class="cta-card profile-cta">
            <h3 class="cta-title">Need More Credits?</h3> <!-- Updated CTA title -->
            <p class="cta-description">Purchase e-vouchers to access premium features and services</p>
            <a href="voucher.html" class="cta-purchase-button"> <!-- Link to voucher page -->
                <i class="fas fa-dollar-sign"></i> Buy E-Vouchers
            </a>
        </section>
    <!-- Edit Profile Modal HTML Block Removed -->
    <!-- ***** BOTTOM NAVIGATION ***** -->
     <nav class="bottom-nav">
          <a href="dashboard.html" class="nav-item"> <i class="fas fa-home"></i> <span>Home</span> </a>
          <a href="profile.html" class="nav-item active"> <i class="fas fa-user"></i> <span>Profile</span> </a> <!-- Active -->
          <a href="ecard.html" class="nav-item"> <i class="fas fa-dollar-sign"></i> <span>Vouchers</span> </a>
          
          <!-- Hidden Items Container (Initially hidden on mobile) -->
          <div id="more-menu-items" class="more-menu-items">
             <a href="copy_trading.html" class="nav-item"> <i class="fas fa-copy"></i> <span>Copy Trading</span> </a>
             <a href="trading_signals.html" class="nav-item"> <i class="fas fa-signal"></i> <span>Signals</span> </a>
             <a href="courses.html" class="nav-item"> <i class="fas fa-graduation-cap"></i> <span>Courses</span> </a>
             <a href="signup.html" class="nav-item"> <i class="fas fa-sign-in-alt"></i> <span>Login/Logout</span> </a>
          </div>
          
          <!-- More Button (Visible only on mobile) -->
          <button id="more-menu-btn" class="nav-item more-menu-btn">
             <i class="fas fa-bars"></i>
             <span>More</span>
          </button>
     </nav>
    <!-- ***** END BOTTOM NAVIGATION ***** -->

    <!-- Voucher Redemption Modal -->
    <div id="voucher-modal" class="modal-overlay" style="display: none;">
        <div class="modal-container">
            <button class="modal-close-btn" id="close-voucher-modal-btn">&times;</button>
            <h2>Redeem E-Voucher</h2>
            <p>Enter the code for your $<span id="voucher-modal-amount">0.00</span> voucher:</p>
            <div class="form-group">
                <label for="modal-voucher-code">Voucher Code:</label>
                <input type="text" id="modal-voucher-code" class="form-control" placeholder="e.g., D123X">
            </div>
            <button id="modal-redeem-btn" class="btn btn-primary">Redeem Code</button>
            <p id="modal-voucher-message" class="modal-message"></p>
        </div>
    </div>

    <!-- Supabase Client Library & Initialization -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="mobile-nav.js"></script>
    <script src="script.js"></script>

    <script>
        // --- DOM Element References ---
        // Wallet/Voucher/Crypto Elements
        const walletBalanceEl = document.getElementById('wallet-current-balance');
        const voucherAmountInput = document.getElementById('voucher-amount');
        const openVoucherModalBtn = document.getElementById('open-voucher-modal-btn');
        const cryptoSelect = document.getElementById('crypto-select');
        const cryptoAmountInput = document.getElementById('crypto-amount');
        const postCryptoAmountBtn = document.getElementById('post-crypto-amount-btn');
        const cryptoDepositAddressEl = document.getElementById('crypto-deposit-address');
        // const cryptoQrCodeEl = document.getElementById('crypto-qr-code'); // Removed QR Code Element Ref
        const selectedCryptoNameEl = document.getElementById('selected-crypto-name');
        const selectedCryptoNameWarnEl = document.getElementById('selected-crypto-name-warn');
        const cryptoTxidInput = document.getElementById('crypto-txid');
        const confirmCryptoSentBtn = document.getElementById('confirm-crypto-sent-btn');
        const transactionHistoryBody = document.getElementById('transaction-history-body');
        const voucherModal = document.getElementById('voucher-modal');
        const closeVoucherModalBtn = document.getElementById('close-voucher-modal-btn');
        const voucherModalAmountEl = document.getElementById('voucher-modal-amount');
        const modalVoucherCodeInput = document.getElementById('modal-voucher-code');
        const modalRedeemBtn = document.getElementById('modal-redeem-btn');
        const modalVoucherMessageEl = document.getElementById('modal-voucher-message');

        // Profile Display Elements
        const profileAvatarInitialEl = document.getElementById('profile-avatar-initial');
        const profileAvatarImgEl = document.getElementById('profile-avatar-img');
        const profileMainNameEl = document.getElementById('profile-main-name');
        const profileDetailNameEl = document.getElementById('profile-detail-name');
        const profileEmailValueEl = document.getElementById('profile-email-value');

        // Action Buttons
        const signOutBtn = document.getElementById('sign-out-btn');

        // Placeholder Data (Keep existing crypto data)
        const cryptoAddresses = { btc: '...', eth: '...', usdt: '...' };
        const cryptoQrCodes = { btc: '#', eth: '#', usdt: '#' };
        const cryptoNames = { btc: 'Bitcoin', eth: 'Ethereum', usdt: 'Tether (ERC20)' };

        // --- Functions ---

        // --- Function to Load User Profile Data ---
        async function loadUserProfile() {
            console.log('Attempting to load user profile...');
            if (typeof supabaseClient === 'undefined') {
                console.error('Supabase client (supabaseClient) is not defined.');
                return;
            }

            const { data: { user }, error: authError } = await supabaseClient.auth.getUser();

            if (authError || !user) {
                console.error('Error fetching user or user not logged in:', authError);
                window.location.href = 'signup.html';
                return;
            }

            console.log('User found:', user);
            const userEmail = user.email;

            // Fetch profile data from 'profiles' table
            let profileData = null; // Initialize profileData to null
            try {
                const { data, error: profileError } = await supabaseClient
                    .from('profiles')
                    .select('first_name, last_name, avatar_url, balance') // Added balance
                    .eq('id', user.id)
                    .single();

                // Check for errors *other than* row not found
                if (profileError && profileError.code !== 'PGRST116') {
                    throw profileError; // Re-throw actual errors
                }
                // If data is returned (even if it's just null for fields), assign it
                profileData = data;
                console.log('Raw profile data fetched:', profileData); // Log fetched data (or null)

            } catch (error) {
                console.error('Error fetching profile data:', error);
                // profileData remains null if an error occurred
            }

            // --- Update UI based on fetched data (or defaults if profileData is null) ---

            // Update Balance Display
            const balanceEl = document.getElementById('wallet-current-balance');
            if (balanceEl) {
                // Use profileData?.balance which handles profileData being null
                const balanceValue = profileData?.balance ?? 0; // Default to 0 if profileData is null or balance is null/undefined
                console.log('Balance value before formatting:', balanceValue); // Log the value being used
                balanceEl.textContent = `$${Number(balanceValue).toFixed(2)}`;
                console.log('Updated balance display:', balanceEl.textContent);
            }

            // Determine display name and initial
            let displayName = '';
            let avatarInitial = '?';
            // Use profileData safely
            if (profileData?.first_name || profileData?.last_name) {
                displayName = `${profileData.first_name || ''} ${profileData.last_name || ''}`.trim();
                avatarInitial = (profileData.first_name || '?').charAt(0).toUpperCase();
            } else {
                const emailPrefix = userEmail.split('@')[0];
                displayName = emailPrefix.charAt(0).toUpperCase() + emailPrefix.slice(1);
                avatarInitial = displayName.charAt(0).toUpperCase();
            }

            // Update main profile display elements
            if (profileMainNameEl) profileMainNameEl.textContent = displayName;
            if (profileDetailNameEl) profileDetailNameEl.textContent = displayName;
            if (profileEmailValueEl) profileEmailValueEl.textContent = userEmail;

            // Update avatar display (Image or Initial)
            // Use profileData safely
            const avatarUrl = profileData?.avatar_url;
            if (avatarUrl && profileAvatarImgEl && profileAvatarInitialEl) {
                profileAvatarImgEl.src = avatarUrl;
                profileAvatarImgEl.style.display = 'block';
                profileAvatarInitialEl.style.display = 'none';
                console.log('Displaying avatar image:', avatarUrl);
            } else if (profileAvatarInitialEl && profileAvatarImgEl) {
                profileAvatarInitialEl.textContent = avatarInitial;
                profileAvatarInitialEl.style.display = 'block';
                profileAvatarImgEl.style.display = 'none';
                 console.log('Displaying avatar initial:', avatarInitial);
            }
        } // End of loadUserProfile function definition

        // Removed redundant fetchAndDisplayBalance function

        // --- Modal Functions --- (Keep existing voucher modal functions)
        function openVoucherModal() {
            const amount = parseFloat(voucherAmountInput.value);
            if (isNaN(amount) || amount <= 0) {
                alert('Please enter a valid positive amount first.');
                return;
            }
            if (voucherModalAmountEl) voucherModalAmountEl.textContent = amount.toFixed(2);
            if (modalVoucherMessageEl) modalVoucherMessageEl.textContent = ''; // Clear previous messages
            if (modalVoucherCodeInput) modalVoucherCodeInput.value = ''; // Clear previous code
            if (voucherModal) voucherModal.style.display = 'flex'; // Show modal
            // Add class after a short delay for transition effect
            setTimeout(() => {
                if (voucherModal) voucherModal.classList.add('active');
            }, 10);
        }

        function closeVoucherModal() {
             if (voucherModal) {
                voucherModal.classList.remove('active');
                 // Hide after transition ends
                setTimeout(() => {
                    voucherModal.style.display = 'none';
                }, 300); // Match transition duration
             }
        }

        function redeemModalVoucherCode() {
            const code = modalVoucherCodeInput.value.trim().toUpperCase(); // Ensure uppercase for validation
            const amountText = voucherModalAmountEl.textContent; // Get amount from modal display
            const amount = parseFloat(amountText);

            // Basic validation (D + 3 digits + X)
            const voucherRegex = /^D\d{3}X$/;
            if (!voucherRegex.test(code)) {
                 if (modalVoucherMessageEl) {
                    modalVoucherMessageEl.textContent = 'Invalid voucher code format. (e.g., D123X)';
                    modalVoucherMessageEl.className = 'modal-message error';
                 }
                return;
            }

            // Simulate API call to redeem
            console.log(`Attempting to redeem voucher code: ${code} for amount: $${amount}`);
             if (modalVoucherMessageEl) {
                modalVoucherMessageEl.textContent = `Redeeming code ${code}...`;
                modalVoucherMessageEl.className = 'modal-message'; // Reset style
             }

            // --- Simulate backend response ---
            setTimeout(() => {
                // Replace with actual backend call result
                const isSuccess = true; // Math.random() > 0.3; // Simulate success/failure

                if (isSuccess) {
                     if (modalVoucherMessageEl) {
                        modalVoucherMessageEl.textContent = `Successfully redeemed $${amountText}! Balance updated.`;
                        modalVoucherMessageEl.className = 'modal-message success';
                     }
                    // We might need to call loadUserProfile here if redemption affects balance
                    // loadUserProfile();
                    fetchAndDisplayHistory(); // Refresh history (placeholder)
                    // Close modal after a delay
                    setTimeout(closeVoucherModal, 1500);
                } else {
                     if (modalVoucherMessageEl) {
                        modalVoucherMessageEl.textContent = 'Redemption failed. Invalid or used code.';
                        modalVoucherMessageEl.className = 'modal-message error';
                     }
                }
            }, 1000); // Simulate network delay
        }

        // Update Crypto Deposit UI based on selection
        function updateCryptoDepositUI() {
            const selectedCoin = cryptoSelect.value;
            const address = cryptoAddresses[selectedCoin] || 'N/A';
            const qrCodeSrc = cryptoQrCodes[selectedCoin] || '#'; // Use # as fallback
            const coinName = cryptoNames[selectedCoin] || 'Selected Coin';

            if (cryptoDepositAddressEl) cryptoDepositAddressEl.textContent = address;
            // if (cryptoQrCodeEl) cryptoQrCodeEl.src = qrCodeSrc; // Removed QR Code Update
            if (selectedCryptoNameEl) selectedCryptoNameEl.textContent = coinName;
            if (selectedCryptoNameWarnEl) selectedCryptoNameWarnEl.textContent = coinName;
        }

        // Handle posting the intended crypto deposit amount
        async function postCryptoAmount() {
            // Disable button temporarily
            if(postCryptoAmountBtn) postCryptoAmountBtn.disabled = true;
            // Consider adding a loading indicator here

            try {
                // 1. Get User
                if (typeof supabaseClient === 'undefined') throw new Error('Supabase client not available.');
                const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
                if (authError || !user) throw new Error('User not authenticated.');

                // 2. Get Inputs & Validate
                const amount = parseFloat(cryptoAmountInput.value);
                const selectedCoin = cryptoSelect.value;

                if (!selectedCoin) {
                     alert('Please select a coin.');
                     return; // Exit early
                }
                if (isNaN(amount) || amount <= 0) {
                    alert('Please enter a valid positive amount for the crypto deposit.');
                    return; // Exit early
                }

                // 3. Prepare data for insertion
                const depositData = {
                    user_id: user.id,
                    coin_symbol: selectedCoin,
                    amount_usd: amount,
                    status: 'pending' // Initial status
                    // txid will be null by default
                };

                console.log('Attempting to insert crypto deposit:', depositData);

                // 4. Insert into Supabase and select the ID of the new record
                const { data: insertedData, error: insertError } = await supabaseClient
                    .from('crypto_deposits')
                    .insert([depositData])
                    .select('id') // Select the ID of the inserted row
                    .single(); // Expecting a single row back

                if (insertError) {
                    throw insertError; // Throw error to be caught by catch block
                }

                if (!insertedData || !insertedData.id) {
                    throw new Error('Failed to retrieve ID of the created deposit record.');
                }

                const depositRecordId = insertedData.id;
                console.log('Crypto deposit intention posted successfully with ID:', depositRecordId);

                // Store the ID for the next step (e.g., using a data attribute or a global variable)
                // Using a data attribute on the button is one way:
                if(confirmCryptoSentBtn) confirmCryptoSentBtn.dataset.depositId = depositRecordId;

                // 5. Success Feedback & Enable Next Step
                alert(`Amount $${amount.toFixed(2)} for ${cryptoNames[selectedCoin]} posted. Please send crypto and enter the Transaction ID below.`);

                // Enable TXID input and Confirm button
                if(cryptoTxidInput) cryptoTxidInput.disabled = false;
                if(confirmCryptoSentBtn) confirmCryptoSentBtn.disabled = false;

                // Optionally clear amount input
                // cryptoAmountInput.value = '';

            } catch (error) {
                // 6. Error Feedback
                console.error('Error posting crypto deposit amount:', error);
                alert(`Error posting amount: ${error.message || 'Please try again.'}`);
            } finally {
                 // Re-enable button regardless of success/failure
                 if(postCryptoAmountBtn) postCryptoAmountBtn.disabled = false;
                 // Remove loading indicator here
            }
        }

        // Handle confirming crypto has been sent and updating the record
        async function confirmCryptoSent() {
            // Disable button
            if(confirmCryptoSentBtn) confirmCryptoSentBtn.disabled = true;
            // Add loading indicator?

            try {
                // 1. Get User (needed for potential checks, though not strictly for update by ID)
                 if (typeof supabaseClient === 'undefined') throw new Error('Supabase client not available.');
                 const { data: { user }, error: authError } = await supabaseClient.auth.getUser();
                 if (authError || !user) throw new Error('User not authenticated.');

                // 2. Get TXID and Deposit Record ID
                const txid = cryptoTxidInput.value.trim();
                const depositRecordId = confirmCryptoSentBtn?.dataset.depositId; // Retrieve ID from button

                if (!txid) {
                    alert('Please enter the Transaction ID.');
                    // Re-enable button if TXID is missing, allowing user to enter it
                    if(confirmCryptoSentBtn) confirmCryptoSentBtn.disabled = false;
                    return; // Exit early
                }
                if (!depositRecordId) {
                    // This case shouldn't happen if postCryptoAmount worked, but good to handle
                    throw new Error('Could not find the deposit record ID. Please post the amount again.');
                }

                // 3. Prepare update data
                const updateData = {
                    txid: txid,
                    status: 'confirming' // Update status
                };

                console.log(`Attempting to update crypto deposit ID ${depositRecordId} with:`, updateData);

                // 4. Update Supabase record
                const { error: updateError } = await supabaseClient
                    .from('crypto_deposits')
                    .update(updateData)
                    .eq('id', depositRecordId) // Target the specific record
                    .eq('user_id', user.id); // Ensure user owns the record (extra check)

                if (updateError) {
                    throw updateError;
                }

                // 5. Success Feedback
                console.log('Crypto deposit confirmation (TXID) submitted successfully.');
                alert(`Transaction ID submitted. Your deposit status is now 'confirming'. Admin will verify shortly.`);

                // Clear TXID input and disable fields again until next deposit
                if(cryptoTxidInput) {
                    cryptoTxidInput.value = '';
                    cryptoTxidInput.disabled = true;
                }
                // Keep button disabled after successful submission for this deposit
                // confirmCryptoSentBtn.disabled = true;
                // Remove the stored ID
                if(confirmCryptoSentBtn) delete confirmCryptoSentBtn.dataset.depositId;


            } catch (error) {
                 // 6. Error Feedback
                console.error('Error confirming crypto deposit:', error);
                alert(`Error submitting Transaction ID: ${error.message || 'Please try again.'}`);
                 // Re-enable button on error ONLY if we want user to retry submitting TXID for SAME deposit
                 if(confirmCryptoSentBtn) confirmCryptoSentBtn.disabled = false;
            } finally {
                 // Remove loading indicator
                 // Button state is handled within try/catch based on outcome
            }
        }


        // Placeholder: Fetch and display transaction history (Keep existing)
        function fetchAndDisplayHistory() {
            // In a real app, fetch data from API and generate rows dynamically
            console.log("Fetching transaction history... (Using placeholder data)");
            // The existing HTML rows serve as placeholders for now.
            // TODO: Clear existing rows (if any) and populate with fetched data
            /*
            const transactions = [ ... fetched data ... ];
            transactionHistoryBody.innerHTML = ''; // Clear placeholders
            transactions.forEach(tx => {
                const row = transactionHistoryBody.insertRow();
                row.innerHTML = `
                    <td>${tx.date}</td>
                    <td>${tx.type}</td>
                    <td>${tx.description}</td>
                    <td class="${tx.amount > 0 ? 'amount-positive' : 'amount-negative'}">${tx.amount > 0 ? '+' : ''}$${Math.abs(tx.amount).toFixed(2)}</td>
                    <td class="status-${tx.status.toLowerCase()}">${tx.status}</td>
                `;
            */
        } // End of fetchAndDisplayHistory function definition


        // --- Event Listeners ---
        // Wallet/Voucher/Crypto Listeners
        if (openVoucherModalBtn) { openVoucherModalBtn.addEventListener('click', openVoucherModal); }
        if (closeVoucherModalBtn) { closeVoucherModalBtn.addEventListener('click', closeVoucherModal); }
        if (modalRedeemBtn) { modalRedeemBtn.addEventListener('click', redeemModalVoucherCode); }
        if (voucherModal) { voucherModal.addEventListener('click', (event) => { if (event.target === voucherModal) closeVoucherModal(); }); }
        if (cryptoSelect) { cryptoSelect.addEventListener('change', updateCryptoDepositUI); }
        if (postCryptoAmountBtn) { postCryptoAmountBtn.addEventListener('click', postCryptoAmount); }
        if (confirmCryptoSentBtn) { confirmCryptoSentBtn.addEventListener('click', confirmCryptoSent); }

        // Sign Out Listener
        if (signOutBtn) {
            signOutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                console.log('Signing out...');
                try {
                    const { error } = await supabaseClient.auth.signOut();
                    if (error) throw error;
                    console.log('Sign out successful.');
                    window.location.href = 'signup.html'; // Redirect after sign out
                } catch (error) {
                    console.error('Error signing out:', error);
                    alert(`Sign out failed: ${error.message}`);
                }
            });
        }
        // Removed Edit Profile Listeners

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            loadUserProfile(); // Load user profile data FIRST
            // Removed call to deleted fetchAndDisplayBalance()
            updateCryptoDepositUI(); // Set initial crypto UI
            fetchAndDisplayHistory(); // Load history (currently uses placeholders)
        });

    </script>
</body>
</html>